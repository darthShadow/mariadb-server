--echo #
--echo # MDEV-12459: The information_schema tables for getting temporary tables
--echo #             info is missing, at least for innodb, there is no
--echo #             INNODB_TEMP_TABLE_INFO
--echo #

# Save the initial number of concurrent sessions
--source include/count_sessions.inc
--source include/have_innodb.inc

--echo # -------------------------------
--echo # Test shadowing of a base table
--echo # -------------------------------

create database some_db;
use some_db;

--echo # Test the warning is raised
create table t(t int);
create temporary table t(t int);
drop table t;
drop table t;
use test;

--echo # ------------------------
--echo # IS.tables tests
--echo # ------------------------

--echo # Create first temporary table
create temporary table test.t_temp(t int);
insert into t_temp values (1),(2), (3);

--echo # Show results
--vertical_results
select table_schema, table_name, temporary from  information_schema.tables where table_type='temporary';

--echo # Create the base table with the same name (both should be visible)
# Create the base table with the same name as temporary table.
create table test.t_temp(t int);
insert into t_temp values (-1),(-2);

--echo # Show results
--vertical_results
select table_schema, table_name, temporary from  information_schema.tables where table_type='temporary';

create database my_db;
--echo # Create the temporary table with the same name in new DB
create temporary table my_db.t_temp (t int);
insert into my_db.t_temp values (-2),(-1);
--echo # Show results
--vertical_results
select table_schema, table_name, temporary from  information_schema.tables where table_type='temporary';

connect (con1,localhost,root,,my_db,,);

--echo # Create the temporary table with the same name in new connection
create temporary table t_temp(t int);
insert into t_temp values (4),(5),(6), (7);
--echo # Show results
--vertical_results
select table_schema, table_name, temporary from  information_schema.tables where table_type='temporary';

connection default;

--echo # Show results in default connection
--vertical_results
select table_schema, table_name, temporary from  information_schema.tables where table_type='temporary';

--echo # Create a warning on `Create` statement if the new temporary table
--echo # shadows base table - note there is no warning vice versa.
create table some_db.my_t (t int);
show warnings;
create temporary table some_db.my_t (t int);
show warnings;

--echo # Show results
--vertical_results
select table_schema, table_name, temporary from  information_schema.tables where table_type='temporary';

# First we are removing temporary table and after base table
drop table some_db.my_t;
drop table some_db.my_t;

disconnect con1;

# Drop both temporary and "real" table from test.
drop table test.t_temp;
drop table test.t_temp;

drop database my_db;
drop database some_db;

# Wait till all disconnects are completed
--source include/wait_until_count_sessions.inc

--echo #
--echo # MDEV-28332: Alter on temporary table causes ER_TABLE_EXISTS_ERROR note
--echo #
create table t (a int);
create temporary table t (b int);
alter table t add c int;

# Cleanup
drop temporary table t;
drop table t;

--echo #
--echo # MDEV-28334: SHOW TABLE STATUS shows all temporary tables
--echo #             ignoring database and conditions
--echo #

create temporary table test.tmp_in_test (a int);
create table test.base_in_test (t int);
# The base table with the same name as temporary table
create table test.tmp_in_test (t int);
# The temporary InnoDB table - CREATE TIME should be NULL, MDEV-28333
create temporary table test.tmp_innodb_in_test (a int) engine=InnoDB;

create database mysqltest;
use mysqltest;

# This should show tables from currently used DB
# no temporary tables created and empty result set should be returned
show table status;

# The same as before
show table status in mysqltest;

# The should show all ables from `test` DB
--replace_column 12 # 13 # 14 #
--horizontal_results
show table status in test;

# The same as before
--replace_column 12 # 13 # 14 #
--horizontal_results
show table status from test;


--echo # check that InnoDB temporary table
--echo # has a NULL value for `Create time` column (MDEV-28333)
select create_time from information_schema.tables where table_name='tmp_innodb_in_test';

# This shouldn't give any results
show table status like 'nonexisting';

# Cleanup
drop database mysqltest;
drop table test.base_in_test;
# We need first to drop temporary table that shadows the base table
drop table test.tmp_in_test;
drop table test.tmp_in_test;
